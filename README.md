# 3rd_party

A script to download specific versions of 3rd party libraries and build them as CMake targets.

### How to build 3rd party libraries

The project is designed to be configured as a standard CMake project.
It uses `FetchContent` module to download and build 3rd party libraries.
Some libraries are patched by custom CMakeLists.txt files before building.

```shell
cmake -S . -B build -D3RD_PARTY_BUILD_EXAMPLES=ON && cmake --build build
```

**Emscripten build**

1. Install Emscripten.

    ```shell
    git clone https://github.com/emscripten-core/emsdk.git
    cd .\emsdk
    .\emsdk install latest
    .\emsdk activate latest
    ```

   Check if Emscripten is installed correctly:

    ```shell
   .\emsdk_env.ps1
    emcc -v
    ```

2. Build `flatc` executable - flatbuffer compiler. It may be done by building this project for a native platform on the same machine. Or it
   can be downloaded from the official releases page: https://github.com/google/flatbuffers/releases/tag/v25.12.19
3. Run CMake with options `CMAKE_TOOLCHAIN_FILE` and `FLATC_HOST_EXECUTABLE` to be set. Example:

```shell
cd .\3rd_party

cmake -S . -B build `
  -DCMAKE_TOOLCHAIN_FILE="$env:EMSDK\upstream\emscripten\cmake\Modules\Platform\Emscripten.cmake" `
  -DFLATC_HOST_EXECUTABLE="C:\path\to\flatc.exe" `
  -D3RD_PARTY_BUILD_EXAMPLES=ON `
  -DCMAKE_C_COMPILER="$env:EMSDK\upstream\emscripten\emcc.bat" `
  -DCMAKE_CXX_COMPILER="$env:EMSDK\upstream\emscripten\em++.bat" `
  -DCMAKE_BUILD_TYPE=Release `
  -DCMAKE_MAKE_PROGRAM="C:\path\to\ninja.exe" `
  -G Ninja
  
cmake --build build
```

### How to use libraries in your project

1. Add this project to your repo as a submodule.
2. Use `add_subdirectory` to include the project in your CMakeLists.txt.
3. All libraries will be available as CMake targets. You do not need to find them manually.

### Examples

For every 3rd party library an example project is present. Building of example projects is disabled by default.
Use `-D3RD_PARTY_BUILD_EXAMPLES=ON` to enable it.

Please see every example project for more details about the library usage.

### SSL/TLS Certificates

#### Autogenerated test certificates

The project uses self-signed certificate for testing purposes. Passphrase is `123Qwe!`.

```shell
./examples/server.crt
./examples/server.key
```

Certificate is generated in the `examples` folder by CMake configure step. See method `generate_test_certificates` in
`ExternalDependencies.cmake`.

Later this certificate is used in the example projects by copying them to the output folder.

Equivalent command to generate certificates on Windows (powershell):

```shell
$env:OPENSSL_CONF = "$PWD/external_install/Debug/openssl/ssl/openssl.cnf"
& "external_install/Debug/openssl/x64/bin/openssl.exe" req -x509 -newkey rsa:2048 -keyout "examples/server.key" -out "examples/server.crt" -days 365 -subj "/CN=localhost"
```

To copy certificates to the `examples` build folder for a specific project, update `CMakeLists.txt`:

```shell
add_custom_command(TARGET YOUR_PROJECT_NAME_HERE POST_BUILD
        COMMAND ${CMAKE_COMMAND} -E copy_if_different
        "${THIRD_PARTY_ROOT}/examples/server.crt"
        "${THIRD_PARTY_ROOT}/examples/server.key"
        $<TARGET_FILE_DIR:YOUR_PROJECT_NAME_HERE>
        COMMENT "WARNING: Copying tests SSL certificates to output directory"
)
```

#### Install test certificate on Windows (optional)

To prevent certificate warnings in your browser and issues with TLS handshake, you need to trust the certificate. The easiest way is to
follow these steps:

1. Double-click on `examples/server.crt` and install it in the `Trusted Root Certification Authorities` store.
2. Restart your browsers.

#### Debug SSL/TLS Handshake

```shell
./external_install/Debug/openssl/x64/bin/openssl.exe s_client -connect 127.0.0.1:12345 -debug -state
```